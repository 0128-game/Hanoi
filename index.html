<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒã‚¤ã®å¡” å…¨ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ</title>
    <style>
        /* ------------------ CSSã®å®šç¾© ------------------ */
        body { font-family: 'Arial', sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #f4f4f9; color: #333; margin: 20px; }
        .wrapper { max-width: 500px; width: 100%; transition: max-width 0.3s ease; }
        h1 { color: #6a0dad; margin-bottom: 10px; }
        #controls, #message-area { background-color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); margin-bottom: 20px; width: 100%; box-sizing: border-box; }
        #message-area { text-align: center; min-height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        #game-board { display: flex; justify-content: space-between; margin-top: 20px; transition: all 0.3s ease; }
        .player-container, .bot-container { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin: 0 5px; background-color: #f9f9f9; width: 100%; box-sizing: border-box; }
        .peg-container { display: flex; justify-content: space-around; height: 250px; align-items: flex-end; position: relative; }
        .peg { width: 10px; background-color: #8b4513; height: 100%; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); z-index: 1; }
        .peg-base { width: 100%; height: 15px; background-color: #5d2b0e; position: absolute; bottom: 0; z-index: 2; border-radius: 3px; }
        .peg-area { width: 30%; height: 100%; position: relative; cursor: pointer; display: flex; flex-direction: column-reverse; align-items: center; justify-content: flex-start; z-index: 3; padding-bottom: 15px; }
        .disk { height: 20px; background-color: #3498db; margin-bottom: 2px; border-radius: 5px; position: relative; z-index: 4; transition: all 0.2s ease-in-out; }
        .disk.selected { border: 3px solid #e74c3c; box-sizing: border-box; margin-top: -20px; }
        .disk.highlight { background-color: #2ecc71; } /* Bot moves highlight */
        
        /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®ãŸã‚ã®CSS */
        .tooltip-container { position: relative; display: inline-block; cursor: help; color: #007bff; border-bottom: 1px dashed #007bff; }
        .tooltip-text {
            visibility: hidden;
            width: 300px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 10;
            bottom: 125%; 
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
            line-height: 1.4;
            white-space: normal;
        }
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .math-formula { display: block; margin: 5px 0; font-family: 'Courier New', monospace; background-color: #444; padding: 5px; border-radius: 3px; }
        /* ----------------------------------------------- */
    </style>
</head>
<body>

    <div class="wrapper" id="wrapper">
        <h1>ãƒãƒã‚¤ã®å¡”</h1>
        
        <div id="controls">
            <h2 style="margin-top: 0;">âš™ï¸ ã‚²ãƒ¼ãƒ è¨­å®š</h2>
            
            <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 15px;">
                <label for="game-mode" style="font-weight: bold;">ãƒ¢ãƒ¼ãƒ‰é¸æŠ:</label>
                <select id="game-mode" onchange="updateModeDisplay()">
                    <option value="manual" selected>1äººç”¨ (æ‰‹å‹•)</option>
                    <option value="versus">ãƒœãƒƒãƒˆã¨å¯¾æˆ¦</option>
                    <option value="two_player">2äººå¯¾æˆ¦</option>
                    <option value="bot_only">ãƒœãƒƒãƒˆ (è‡ªå‹•ã‚¯ãƒªã‚¢)</option>
                </select>
                
                <label for="disks" style="width: auto;">å††ç›¤ã®æ•° (3-64):</label> 
                <input type="number" id="disks" value="3" min="3" max="64">
                
                <button id="execute-button" onclick="initGame()">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
            </div>
            
            <div id="two-player-settings" style="display: none; width: 100%; margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 10px;">
                <h3 style="color: #6a0dad; margin: 5px 0 10px 0;">âš”ï¸ 2äººå¯¾æˆ¦è¨­å®š</h3>
                <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 15px;">
                    
                    <label for="win-condition" style="font-weight: bold;">å‹åˆ©æ¡ä»¶:</label>
                    <select id="win-condition">
                        <option value="single_stack_win" selected>æœ€çŸ­ã‚¯ãƒªã‚¢ (æœ€åˆã«å…¨å††ç›¤ç§»å‹•)</option>
                        <option value="min_moves_win">æœ€å°æ‰‹æ•°é”æˆ</option>
                        <option value="min_time_win">æœ€çŸ­æ™‚é–“é”æˆ</option>
                        <option value="mixed_win">ãƒŸãƒƒã‚¯ã‚¹</option>
                    </select>
                    
                    <div class="tooltip-container">
                        [ãƒŸãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢ ãƒ˜ãƒ«ãƒ—]
                        <span class="tooltip-text">
                            <h4>ãƒŸãƒƒã‚¯ã‚¹åŠ¹ç‡ã‚¹ã‚³ã‚¢:</h4>
                            ã‚¹ãƒ”ãƒ¼ãƒ‰ã¨æ­£ç¢ºã•ã®ãƒãƒ©ãƒ³ã‚¹ã‚’è©•ä¾¡ã—ã¾ã™ã€‚ã‚¹ã‚³ã‚¢ãŒä½ã„æ–¹ãŒå‹åˆ©ã§ã™ã€‚
                            $$
                            \text{Score} = \text{Time (ç§’)} \times \frac{\text{Actual Moves}}{\text{Minimum Moves}}
                            $$
                            æœ€å°æ‰‹æ•° ($M = 2^N - 1$)
                        </span>
                    </div>

                    <label for="time-limit" style="font-weight: bold; color: #dc3545;">åˆ¶é™æ™‚é–“ (åˆ†):</label>
                    <input type="number" id="time-limit" value="0" min="0" max="60" style="width: 60px;">
                    <span style="font-size: 14px; margin-left: -5px;">(0ã§æ™‚é–“ç„¡åˆ¶é™)</span>
                </div>
            </div>
            
            <div id="rate-display" style="display: none; margin-top: 15px;">
                <label for="bot-speed">ãƒœãƒƒãƒˆã®é€Ÿåº¦ (ms):</label>
                <input type="number" id="bot-speed" value="500" min="10">
                <label for="handicap-moves" style="margin-left: 10px;">ãƒãƒ³ãƒ‡æ‰‹æ•°:</label>
                <input type="number" id="handicap-moves" value="0" min="0">
            </div>
        </div>

        <div id="message-area">ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¦ãã ã•ã„</div>

        <div style="display: flex; justify-content: space-between; width: 100%; margin-top: 10px; font-weight: bold;">
            <span>æ‰‹æ•°: <span id="moves-display">0</span> (æœ€å°: <span id="min-moves-display">7</span>)</span>
            <span>ã‚¿ã‚¤ãƒ : <span id="time-display">00:00.00</span></span>
        </div>

        <div id="game-board">
            <div class="player-container" id="player-container">
                <h3 style="text-align: center; color: #2980b9;">P1 (ã‚­ãƒ¼: 1, 2, 3)</h3>
                <div class="peg-container">
                    <div class="peg-area" id="peg-area-1"><div class="peg"></div><div class="peg-base"></div></div>
                    <div class="peg-area" id="peg-area-2"><div class="peg"></div><div class="peg-base"></div></div>
                    <div class="peg-area" id="peg-area-3"><div class="peg"></div><div class="peg-base"></div></div>
                </div>
            </div>
            
            <div class="bot-container" id="bot-container" style="display: none;">
                <h3 style="text-align: center; color: #c0392b;" id="bot-title">P2 (ã‚­ãƒ¼: 4, 5, 6)</h3>
                <div class="peg-container">
                    <div class="peg-area" id="bot-peg-area-1"><div class="peg"></div><div class="peg-base"></div></div>
                    <div class="peg-area" id="bot-peg-area-2"><div class="peg"></div><div class="peg-base"></div></div>
                    <div class="peg-area" id="bot-peg-area-3"><div class="peg"></div><div class="peg-base"></div></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ------------------ JavaScriptã®å®šç¾© ------------------
        
        // DOMè¦ç´ ã®å–å¾—
        const gameModeSelect = document.getElementById('game-mode');
        const disksInput = document.getElementById('disks');
        const executeButton = document.getElementById('execute-button');
        const messageDisplay = document.getElementById('message-area');
        const movesDisplay = document.getElementById('moves-display');
        const minMovesDisplay = document.getElementById('min-moves-display');
        const timeDisplay = document.getElementById('time-display');
        const botSpeedControls = document.getElementById('rate-display'); // ãƒœãƒƒãƒˆè¨­å®šå…¨ä½“
        const botSpeedInput = document.getElementById('bot-speed');
        const handicapInput = document.getElementById('handicap-moves');
        const botTitle = document.getElementById('bot-title');
        const twoPlayerSettings = document.getElementById('two-player-settings'); // 2äººå¯¾æˆ¦è¨­å®šå…¨ä½“
        const winConditionSelect = document.getElementById('win-condition');
        const timeLimitInput = document.getElementById('time-limit');

        const playerContainer = document.getElementById('player-container');
        const botContainer = document.getElementById('bot-container');
        const wrapper = document.getElementById('wrapper');

        const playerPegElements = [
            document.getElementById('peg-area-1'),
            document.getElementById('peg-area-2'),
            document.getElementById('peg-area-3')
        ];
        const botPegElements = [
            document.getElementById('bot-peg-area-1'),
            document.getElementById('bot-peg-area-2'),
            document.getElementById('bot-peg-area-3')
        ];

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let disksCount = 3;
        let playerPegsState = [[], [], []];
        let botPegsState = [[], [], []];

        let timerInterval = null;
        let startTime = 0;
        let isTimerRunning = false;
        let moves = 0; // å…¨ä½“/P1ã®æ‰‹æ•°
        let minMoves = 7;
        let playerWon = false;
        let botWon = false;

        let botMoveTimeout = null;
        let isBotRunning = false;
        let moveQueue = [];
        let botHandicapMoves = 0;
        let currentBotSpeedMs = 500;

        // â˜…2äººå¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰ç”¨ã®çŠ¶æ…‹
        let p1SelectedDisk = null;
        let p1SourcePegIndex = -1;
        let p2SelectedDisk = null;
        let p2SourcePegIndex = -1;
        let currentPlayer = 1;         
        let timeLimitMinutes = 0;
        let winCondition = 'single_stack_win';
        
        // â˜…2äººå¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰ã®è¨˜éŒ²
        let p1TotalMoves = 0;
        let p2TotalMoves = 0;
        let p1ClearTimeMs = Infinity; 
        let p2ClearTimeMs = Infinity; 
        let p1HasCleared = false;
        let p2HasCleared = false;

        // å®šæ•°
        const PEG_HEIGHT = 250;
        const DISK_MARGIN = 2;

        // ------------------ ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ ------------------

        function updateModeDisplay() {
            const mode = gameModeSelect.value;
            
            let buttonLabel = 'ã‚²ãƒ¼ãƒ é–‹å§‹';
            
            // å…¨ã¦ã®ãƒ¢ãƒ¼ãƒ‰ã§å…±é€šã—ã¦éè¡¨ç¤ºã«ã™ã‚‹è¨­å®šã‚’åˆæœŸåŒ–
            botSpeedControls.style.display = 'none'; // ãƒœãƒƒãƒˆè¨­å®šã‚’éè¡¨ç¤º
            twoPlayerSettings.style.display = 'none'; // 2äººå¯¾æˆ¦è¨­å®šã‚’éè¡¨ç¤º
            botTitle.textContent = 'P2 (ã‚­ãƒ¼: 4, 5, 6)';
            botTitle.style.color = '#c0392b';

            if (mode === 'versus') {
                botSpeedControls.style.display = 'flex';
                buttonLabel = 'ãƒœãƒƒãƒˆå¯¾æˆ¦é–‹å§‹';
                wrapper.style.maxWidth = '1000px'; 
                playerContainer.style.width = '48%'; 
                botContainer.style.display = 'block';
                botTitle.textContent = 'Bot (è‡ªå‹•)';
                botTitle.style.color = '#2c3e50';
            } else if (mode === 'two_player') {
                twoPlayerSettings.style.display = 'block'; 
                buttonLabel = '2äººå¯¾æˆ¦é–‹å§‹';
                wrapper.style.maxWidth = '1000px'; 
                playerContainer.style.width = '48%'; 
                botContainer.style.display = 'block';
            } else if (mode === 'bot_only') {
                botSpeedControls.style.display = 'flex';
                buttonLabel = 'è‡ªå‹•ã‚¯ãƒªã‚¢é–‹å§‹';
                wrapper.style.maxWidth = '500px';
                playerContainer.style.width = '100%';
                botContainer.style.display = 'none';
            } else { // manual
                buttonLabel = 'æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰é–‹å§‹';
                wrapper.style.maxWidth = '500px';
                playerContainer.style.width = '100%';
                botContainer.style.display = 'none';
            }
            
            executeButton.textContent = buttonLabel;
            initGame();
        }

        // ------------------ ã‚²ãƒ¼ãƒ åˆæœŸåŒ– ------------------

        function initGame() {
            if (timerInterval) clearInterval(timerInterval);
            if (botMoveTimeout) clearTimeout(botMoveTimeout);

            const newDisksCount = parseInt(disksInput.value);
            if (isNaN(newDisksCount) || newDisksCount < 3 || newDisksCount > 64) {
                alert("å††ç›¤ã®æ•°ã¯3ã‹ã‚‰64ã®é–“ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            disksCount = newDisksCount;
            
            // çŠ¶æ…‹ã¨DOMã®ãƒªã‚»ãƒƒãƒˆ
            playerPegsState = [[], [], []];
            botPegsState = [[], [], []];
            playerPegElements.forEach(peg => { while (peg.querySelector('.disk')) peg.querySelector('.disk').remove(); });
            botPegElements.forEach(peg => { while (peg.querySelector('.disk')) peg.querySelector('.disk').remove(); });

            moves = 0;
            movesDisplay.textContent = 0;
            minMoves = Math.pow(2, disksCount) - 1;
            minMovesDisplay.textContent = minMoves;
            timeDisplay.textContent = "00:00.00";
            playerWon = false;
            botWon = false;
            isTimerRunning = false;
            isBotRunning = false;
            moveQueue = [];

            // â˜…2äººå¯¾æˆ¦ç”¨ã®çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆã¨è¨­å®šå–å¾—
            currentPlayer = 1; 
            p1SelectedDisk = null; 
            p1SourcePegIndex = -1;
            p2SelectedDisk = null; 
            p2SourcePegIndex = -1;
            p1TotalMoves = 0;
            p2TotalMoves = 0;
            p1ClearTimeMs = Infinity; 
            p2ClearTimeMs = Infinity; 
            p1HasCleared = false;
            p2HasCleared = false;
            timeLimitMinutes = parseInt(timeLimitInput.value);
            winCondition = winConditionSelect.value;

            // å††ç›¤ã®é…ç½®ãƒ­ã‚¸ãƒƒã‚¯
            const totalMarginHeight = (disksCount - 1) * DISK_MARGIN;
            const availableHeight = PEG_HEIGHT - totalMarginHeight;
            const diskHeight = Math.floor(availableHeight / disksCount);
            const MIN_WIDTH = 50;
            const MAX_WIDTH = 180;
            const widthRange = MAX_WIDTH - MIN_WIDTH;

            for (let i = disksCount; i >= 1; i--) {
                const diskWidth = MIN_WIDTH + ((i - 1) / (disksCount - 1 || 1)) * widthRange;
                const hue = (i / disksCount) * 360;

                // P1ç›¤é¢ã«é…ç½®
                const pDisk = document.createElement('div');
                pDisk.classList.add('disk');
                pDisk.dataset.size = i;
                pDisk.style.width = `${diskWidth}px`;
                pDisk.style.height = `${diskHeight}px`;
                pDisk.style.backgroundColor = `hsl(${hue}, 80%, 50%)`;
                playerPegElements[0].appendChild(pDisk);
                playerPegsState[0].push(i);

                // P2ç›¤é¢ï¼ˆbot-pegï¼‰ã«é…ç½® (2äººå¯¾æˆ¦/ãƒœãƒƒãƒˆå¯¾æˆ¦æ™‚ã®ã¿)
                if (gameModeSelect.value === 'two_player' || gameModeSelect.value === 'versus') {
                    const bDisk = document.createElement('div');
                    bDisk.classList.add('disk', 'bot-disk');
                    bDisk.dataset.size = i;
                    bDisk.style.width = `${diskWidth}px`;
                    bDisk.style.height = `${diskHeight}px`;
                    bDisk.style.backgroundColor = `hsl(${hue}, 80%, 50%)`;
                    botPegElements[0].appendChild(bDisk);
                    botPegsState[0].push(i);
                }
            }

            // ãƒ¢ãƒ¼ãƒ‰ã”ã¨ã®åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            const mode = gameModeSelect.value;
            if (mode === 'two_player') {
                messageDisplay.textContent = `âš”ï¸ 2äººå¯¾æˆ¦é–‹å§‹ï¼P1 (1/2/3ã‚­ãƒ¼) ã®ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚`;
                if (timeLimitMinutes > 0) {
                    messageDisplay.textContent += ` ğŸ•’ åˆ¶é™æ™‚é–“ã¯ ${timeLimitMinutes} åˆ†ã§ã™ã€‚`;
                }
            } else if (mode === 'versus') {
                currentBotSpeedMs = parseInt(botSpeedInput.value);
                botHandicapMoves = parseInt(handicapInput.value);
                messageDisplay.textContent = "âš”ï¸ ãƒœãƒƒãƒˆå¯¾æˆ¦é–‹å§‹ï¼P1ã‹ã‚‰æ“ä½œã—ã¦ãã ã•ã„ã€‚";
            } else if (mode === 'bot_only') {
                currentBotSpeedMs = parseInt(botSpeedInput.value);
                messageDisplay.textContent = "ãƒœãƒƒãƒˆã«ã‚ˆã‚‹è‡ªå‹•ã‚¯ãƒªã‚¢ã‚’é–‹å§‹ãƒœã‚¿ãƒ³ã§é–‹å§‹ã—ã¾ã™ã€‚";
            } else {
                messageDisplay.textContent = "æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚";
            }
        }
        
        // ------------------ ã‚¿ã‚¤ãƒãƒ¼é–¢æ•° ------------------

        function updateTimer() {
            const elapsed = Date.now() - startTime;
            const totalSeconds = Math.floor(elapsed / 1000);
            const milliseconds = Math.floor(elapsed % 1000 / 10);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            timeDisplay.textContent = 
                `${String(minutes).padStart(2, '0')}:` +
                `${String(seconds).padStart(2, '0')}.` +
                `${String(milliseconds).padStart(2, '0')}`;
        }
        
        function updateCountdownTimer(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const milliseconds = Math.floor(ms % 1000 / 10);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const formattedTime = 
                `${String(minutes).padStart(2, '0')}:` +
                `${String(seconds).padStart(2, '0')}.` +
                `${String(milliseconds).padStart(2, '0')}`;
            timeDisplay.textContent = formattedTime;
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            isTimerRunning = true;
            
            const limitMs = timeLimitMinutes * 60 * 1000;
            
            if (gameModeSelect.value === 'two_player' && timeLimitMinutes > 0) {
                // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒãƒ¼
                startTime = Date.now();
                timerInterval = setInterval(() => {
                    const elapsed = Date.now() - startTime;
                    const remaining = limitMs - elapsed;

                    if (remaining <= 0) {
                        clearInterval(timerInterval);
                        timeDisplay.textContent = "00:00.00";
                        handleTimeOver();
                        return;
                    }
                    updateCountdownTimer(remaining);
                }, 10);
            } else {
                // ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒãƒ¼ (é€šå¸¸/æ™‚é–“ç„¡åˆ¶é™)
                startTime = Date.now();
                timerInterval = setInterval(updateTimer, 10);
            }
        }

        function stopTimer() {
            if (timerInterval) clearInterval(timerInterval);
            isTimerRunning = false;
        }
        
        function handleTimeOver() {
            if (playerWon || botWon) return; 

            if (gameModeSelect.value === 'two_player') {
                stopTimer();
                messageDisplay.textContent = "âŒ› ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—ï¼å‹æ•—ã¯åˆ¤å®šã§ãã¾ã›ã‚“ã§ã—ãŸ (å¼•ãåˆ†ã‘)ã€‚";
            }
        }

        // ------------------ ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ------------------

        /**
         * å††ç›¤ã®ç§»å‹•ã‚’è©¦ã¿ã‚‹ (P1/P2/Botå…±ç”¨)
         */
        function attemptMoveUniversal(sourceIndex, targetIndex, pegElements, pegState, diskElement) {
            const targetPeg = pegElements[targetIndex];
            const topDiskOnTarget = targetPeg.querySelector('.disk:last-child');
            
            if (!diskElement) return false; 

            const selectedSize = parseInt(diskElement.dataset.size);
            const topDiskSize = topDiskOnTarget ? parseInt(topDiskOnTarget.dataset.size) : Infinity;

            if (selectedSize < topDiskSize) {
                // DOMã®ç§»å‹•
                diskElement.parentNode.removeChild(diskElement);
                targetPeg.appendChild(diskElement);
                
                // çŠ¶æ…‹ã®æ›´æ–°
                pegState[sourceIndex].pop();
                pegState[targetIndex].push(selectedSize);

                return true;
            } else {
                return false;
            }
        }

        /**
         * P1/P2ã®å‹åˆ©ã‚’åˆ¤å®šã™ã‚‹ï¼ˆ2äººå¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰å°‚ç”¨ï¼‰
         */
        function checkTwoPlayerWin(isP1) {
            if (playerWon || botWon) return; 

            const targetState = isP1 ? playerPegsState : botPegsState;
            
            const isCleared = (targetState[1].length === disksCount) || (targetState[2].length === disksCount);
            
            // --- 1. æœ€çŸ­ã‚¯ãƒªã‚¢ (single_stack_win) ---
            if (winCondition === 'single_stack_win') {
                if (isCleared) {
                    const winner = isP1 ? 'P1' : 'P2';
                    stopTimer();
                    playerWon = isP1;
                    botWon = !isP1; 
                    messageDisplay.textContent = `ğŸ‰ ${winner} ã®å‹åˆ©ã§ã™ï¼ (æœ€çŸ­ã‚¯ãƒªã‚¢é”æˆ) ã‚¿ã‚¤ãƒ : ${timeDisplay.textContent}ã€æ‰‹æ•°: ${isP1 ? p1TotalMoves : p2TotalMoves} å›`;
                    return;
                }
            }

            // --- 2. ç·åˆè¨˜éŒ²åˆ¶ã®æº–å‚™ï¼ˆè¨˜éŒ²ã®ä¿æŒï¼‰ ---
            if (isCleared) {
                if (isP1 && !p1HasCleared) {
                    p1HasCleared = true;
                    p1ClearTimeMs = Date.now() - startTime;
                } else if (!isP1 && !p2HasCleared) {
                    p2HasCleared = true;
                    p2ClearTimeMs = Date.now() - startTime;
                }
            }

            // --- 3. ç·åˆè¨˜éŒ²åˆ¶ã®å‹æ•—æ±ºå®šï¼ˆä¸¡è€…ã‚¯ãƒªã‚¢ãŒå‰æï¼‰ ---
            if (p1HasCleared && p2HasCleared) {
                stopTimer();
                let winnerMessage = '';
                let p1Score = 0;
                let p2Score = 0;
                
                const M = minMoves; 

                if (winCondition === 'min_moves_win') {
                    p1Score = p1TotalMoves;
                    p2Score = p2TotalMoves;
                    winnerMessage = 'æœ€å°æ‰‹æ•°';
                } else if (winCondition === 'min_time_win') {
                    p1Score = p1ClearTimeMs;
                    p2Score = p2ClearTimeMs;
                    winnerMessage = 'æœ€çŸ­æ™‚é–“';
                } else if (winCondition === 'mixed_win') {
                    // ãƒŸãƒƒã‚¯ã‚¹åŠ¹ç‡ã‚¹ã‚³ã‚¢: Score = Time (ç§’) Ã— (Actual Moves / Minimum Moves)
                    const p1TimeSec = p1ClearTimeMs / 1000;
                    const p2TimeSec = p2ClearTimeMs / 1000;
                    
                    p1Score = p1TimeSec * (p1TotalMoves / M);
                    p2Score = p2TimeSec * (p2TotalMoves / M);
                    
                    winnerMessage = 'ãƒŸãƒƒã‚¯ã‚¹åŠ¹ç‡ã‚¹ã‚³ã‚¢';
                }

                if (p1Score < p2Score) {
                    playerWon = true;
                    messageDisplay.textContent = `ğŸ‰ P1 ã®å‹åˆ©ã§ã™ï¼ (${winnerMessage}é”æˆ)`;
                } else if (p2Score < p1Score) {
                    botWon = true;
                    messageDisplay.textContent = `ğŸ‰ P2 ã®å‹åˆ©ã§ã™ï¼ (${winnerMessage}é”æˆ)`;
                } else {
                    messageDisplay.textContent = `ğŸ¤ å¼•ãåˆ†ã‘ã§ã™ï¼ (${winnerMessage}ãŒåŒç‚¹)`;
                }
                
                // è©³ç´°ã‚¹ã‚³ã‚¢ã®è¡¨ç¤º
                let detailMessage = ` P1è¨˜éŒ²: æ‰‹æ•°${p1TotalMoves}å›, æ™‚é–“${(p1ClearTimeMs/1000).toFixed(2)}ç§’`;
                detailMessage += ` | P2è¨˜éŒ²: æ‰‹æ•°${p2TotalMoves}å›, æ™‚é–“${(p2ClearTimeMs/1000).toFixed(2)}ç§’`;
                if (winCondition === 'mixed_win') {
                    detailMessage += ` | P1ã‚¹ã‚³ã‚¢: ${p1Score.toFixed(2)}, P2ã‚¹ã‚³ã‚¢: ${p2Score.toFixed(2)}`;
                }
                messageDisplay.textContent += detailMessage;
            }
        }
        
        // æ—¢å­˜ã®å‹åˆ©åˆ¤å®šé–¢æ•°ï¼ˆãƒœãƒƒãƒˆ/æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰
        function checkWin() { 
            const mode = gameModeSelect.value;
            // P1ãŒè§£ã„ãŸã‹ã©ã†ã‹ï¼ˆé€šå¸¸ã¯æ­2ã‹æ­3ã«å…¨å††ç›¤ï¼‰
            if (playerPegsState[1].length === disksCount || playerPegsState[2].length === disksCount) {
                if (!playerWon) {
                    playerWon = true;
                    stopTimer();
                    messageDisplay.textContent = `ğŸ‰ P1 ã®å‹åˆ©ã§ã™ï¼ã‚¿ã‚¤ãƒ : ${timeDisplay.textContent}ã€æ‰‹æ•°: ${moves} å›`;
                    // ãƒœãƒƒãƒˆå¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ã“ã“ã§ãƒœãƒƒãƒˆã®å‹•ãã‚’åœæ­¢ã•ã›ã‚‹
                    if (mode === 'versus') {
                        if (botMoveTimeout) clearTimeout(botMoveTimeout);
                        isBotRunning = false;
                    }
                }
            }
        }
        
        function botWinCheck() { 
             const mode = gameModeSelect.value;
             // ãƒœãƒƒãƒˆ/P2ãŒè§£ã„ãŸã‹ã©ã†ã‹
            if (botPegsState[1].length === disksCount || botPegsState[2].length === disksCount) {
                if (!botWon) {
                    botWon = true;
                    stopTimer();
                    if(mode === 'versus') {
                        messageDisplay.textContent = `ğŸ˜­ ãƒœãƒƒãƒˆã®å‹åˆ©ã§ã™ã€‚ã‚¿ã‚¤ãƒ : ${timeDisplay.textContent}ã€æ‰‹æ•°: ${moves} å›`;
                    }
                    // ãƒœãƒƒãƒˆè‡ªå‹•ã‚¯ãƒªã‚¢ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ã“ã“ã§åœæ­¢
                    if (mode === 'bot_only') {
                        messageDisplay.textContent = `âœ… ãƒœãƒƒãƒˆãŒã‚¯ãƒªã‚¢ã—ã¾ã—ãŸï¼ã‚¿ã‚¤ãƒ : ${timeDisplay.textContent}ã€æ‰‹æ•°: ${moves} å›`;
                        if (botMoveTimeout) clearTimeout(botMoveTimeout);
                        isBotRunning = false;
                    }
                }
            }
        }
        
        // ------------------ ãƒœãƒƒãƒˆåˆ¶å¾¡é–¢æ•° (ãƒãƒã‚¤ã®å¡”ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ) ------------------

        /**
         * ãƒãƒã‚¤ã®å¡”ã®æœ€å°æ‰‹æ•°è§£ã‚’å†å¸°çš„ã«ç”Ÿæˆã™ã‚‹
         * @param {number} n - å††ç›¤ã®æ•°
         * @param {number} source - å§‹ç‚¹ã®æ­ (0, 1, 2)
         * @param {number} destination - çµ‚ç‚¹ã®æ­ (0, 1, 2)
         * @param {number} auxiliary - ä½œæ¥­ç”¨ã®æ­ (0, 1, 2)
         * @param {Array} movesArray - ç§»å‹•æ‰‹é †ã‚’æ ¼ç´ã™ã‚‹é…åˆ—
         */
        function hanoi(n, source, destination, auxiliary, movesArray) {
            if (n === 1) {
                movesArray.push({ from: source, to: destination });
                return;
            }
            hanoi(n - 1, source, auxiliary, destination, movesArray);
            movesArray.push({ from: source, to: destination });
            hanoi(n - 1, auxiliary, destination, source, movesArray);
        }

        /**
         * ãƒœãƒƒãƒˆã®æ‰‹é †ã‚’ç”Ÿæˆã—ã€ãƒãƒ³ãƒ‡ã‚’é©ç”¨ã™ã‚‹
         * @param {number} n - å††ç›¤ã®æ•°
         * @param {number} source - å§‹ç‚¹
         * @param {number} destination - çµ‚ç‚¹
         * @param {number} auxiliary - ä½œæ¥­æ­
         * @param {number} handicap - ãƒãƒ³ãƒ‡æ‰‹æ•°
         */
        function generateBotMovesWithHandicap(n, source, destination, auxiliary, handicap) {
            moveQueue = [];
            hanoi(n, source, destination, auxiliary, moveQueue);
            
            // ãƒãƒ³ãƒ‡å‡¦ç†ï¼ˆæœ€åˆã®æ•°æ‰‹/æœ€å¾Œã®æ•°æ‰‹ã‚’å‰Šã‚‹ãªã©ã€å˜ç´”åŒ–ã®ãŸã‚ã€ã“ã“ã§ã¯æœ€åˆã®æ•°æ‰‹ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹å‡¦ç†ã¯å®Ÿè£…ã—ã¦ã„ã¾ã›ã‚“ï¼‰
            // ä¾‹: if (handicap > 0) moveQueue.splice(0, handicap);
        }

        /**
         * ãƒœãƒƒãƒˆã®ç§»å‹•ã‚’é–‹å§‹ã™ã‚‹
         * @param {number} speedMs - ç§»å‹•é€Ÿåº¦ (ms)
         */
        function startBotMoves(speedMs) {
            if (isBotRunning || playerWon || botWon || moveQueue.length === 0) return;
            isBotRunning = true;
            
            if (!isTimerRunning) startTimer();

            function nextMove() {
                if (moveQueue.length === 0 || playerWon || botWon) {
                    isBotRunning = false;
                    return;
                }
                
                const move = moveQueue.shift();
                const source = move.from;
                const target = move.to;

                // DOMè¦ç´ ã¨çŠ¶æ…‹ã‚’å–å¾—
                const diskElement = botPegElements[source].querySelector('.disk:last-child');
                
                if (attemptMoveUniversal(source, target, botPegElements, botPegsState, diskElement)) {
                    moves++; movesDisplay.textContent = moves; // ãƒœãƒƒãƒˆã®æ‰‹æ•°ã‚‚å…¨ä½“æ‰‹æ•°ã«ã‚«ã‚¦ãƒ³ãƒˆ
                    botWinCheck();

                    if (!playerWon && !botWon) {
                        botMoveTimeout = setTimeout(nextMove, speedMs);
                    }
                } else {
                    // ãƒ«ãƒ¼ãƒ«é•åãŒç™ºç”Ÿã—ãŸå ´åˆ (é€šå¸¸ã¯ç™ºç”Ÿã—ãªã„)
                    isBotRunning = false;
                }
            }

            botMoveTimeout = setTimeout(nextMove, speedMs);
        }


        // ------------------ é¸æŠçŠ¶æ…‹ã®ãƒªã‚»ãƒƒãƒˆ ------------------

        /**
         * é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹
         * @param {boolean|null} isP1 - ãƒªã‚»ãƒƒãƒˆå¯¾è±¡ãŒP1ãªã‚‰true, P2ãªã‚‰false, null/undefinedãªã‚‰å…¨ä½“
         */
        function resetSelection(isP1 = undefined) {
            if (isP1 === true || isP1 === undefined) {
                if (p1SelectedDisk) p1SelectedDisk.classList.remove('selected');
                p1SelectedDisk = null;
                p1SourcePegIndex = -1;
            }
            if (isP1 === false || isP1 === undefined) {
                if (p2SelectedDisk) p2SelectedDisk.classList.remove('selected');
                p2SelectedDisk = null;
                p2SourcePegIndex = -1;
            }
        }
        
        // ------------------ ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›å‡¦ç† ------------------

        function handleKeyPress(event) {
            const mode = gameModeSelect.value;
            if (mode === 'bot_only' || isBotRunning) return; // ãƒœãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ä¸­ã¯å…¥åŠ›ã‚’ç„¡è¦–

            if (playerWon || botWon) return; 

            const key = event.key;
            let pegIndex = -1;
            let isP1Move = false;
            let playerNumber = -1;

            if (key === '1' || key === '2' || key === '3') {
                pegIndex = parseInt(key) - 1; 
                isP1Move = true;
                playerNumber = 1;
            } else if (key === '4' || key === '5' || key === '6') {
                pegIndex = parseInt(key) - 4;
                isP1Move = false;
                playerNumber = 2;
            } else if (key === 'Escape') {
                resetSelection(undefined); // å…¨ä½“ãƒªã‚»ãƒƒãƒˆ
                messageDisplay.textContent = "é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚";
                return;
            } else {
                return; 
            }
            
            // --- ãƒ¢ãƒ¼ãƒ‰ã¨ã‚¿ãƒ¼ãƒ³åˆ¶ã®æ’ä»–åˆ¶å¾¡ ---
            if (mode === 'two_player' && playerNumber !== currentPlayer) {
                messageDisplay.textContent = `P${playerNumber} ã®æ“ä½œã¯ã§ãã¾ã›ã‚“ã€‚ç¾åœ¨ã¯ P${currentPlayer} ã®ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚`;
                return;
            }
            if ((mode === 'versus' || mode === 'manual') && !isP1Move) {
                messageDisplay.textContent = "ã“ã®ãƒ¢ãƒ¼ãƒ‰ã§ã¯P1ã®ç›¤é¢ï¼ˆ1/2/3ã‚­ãƒ¼ï¼‰ã®ã¿æ“ä½œã—ã¾ã™ã€‚";
                return;
            }

            // --- P1/P2åˆ¥ é¸æŠçŠ¶æ…‹ã®å–å¾— ---
            const targetPegElements = isP1Move ? playerPegElements : botPegElements;
            let currentSelectedDisk = isP1Move ? p1SelectedDisk : p2SelectedDisk;
            let currentSourceIndex = isP1Move ? p1SourcePegIndex : p2SourcePegIndex;
            
            const currentPegElement = targetPegElements[pegIndex];
            
            if (currentSourceIndex === -1) {
                // --- 1. å††ç›¤ã®é¸æŠ ---
                const topDisk = currentPegElement.querySelector('.disk:last-child');
                if (topDisk) {
                    if (!isTimerRunning) {
                         startTimer();
                         // ãƒœãƒƒãƒˆå¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹æ™‚ã«ãƒœãƒƒãƒˆã®æ‰‹é †ã‚’æº–å‚™ã—ã€é–‹å§‹
                         if(mode === 'versus') {
                             generateBotMovesWithHandicap(disksCount, 0, 1, 2, botHandicapMoves);
                             startBotMoves(currentBotSpeedMs);
                         } else if (mode === 'bot_only') {
                             // bot_onlyã¯ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§é–‹å§‹ã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„
                         }
                    } 

                    topDisk.classList.add('selected');
                    
                    if (isP1Move) {
                        p1SourcePegIndex = pegIndex;
                        p1SelectedDisk = topDisk;
                    } else {
                        p2SourcePegIndex = pegIndex;
                        p2SelectedDisk = topDisk;
                    }
                    messageDisplay.textContent = `P${playerNumber}: æ­ ${pegIndex + 1} ã‚’å§‹ç‚¹ã¨ã—ã¦é¸æŠã€‚ç§»å‹•å…ˆã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`;
                } else {
                    messageDisplay.textContent = `P${playerNumber}: æ­ ${pegIndex + 1} ã«ã¯å‹•ã‹ã›ã‚‹å††ç›¤ãŒã‚ã‚Šã¾ã›ã‚“ã€‚`;
                }
            } else {
                // --- 2. å††ç›¤ã®ç§»å‹• ---
                const targetPegIndex = pegIndex;
                if (currentSourceIndex === targetPegIndex) {
                    resetSelection(isP1Move); 
                    messageDisplay.textContent = `P${playerNumber}: é¸æŠã‚’è§£é™¤ã—ã¾ã—ãŸã€‚`;
                    return;
                }

                const isSuccess = attemptMoveUniversal(
                    currentSourceIndex, 
                    targetPegIndex, 
                    targetPegElements,
                    isP1Move ? playerPegsState : botPegsState,
                    currentSelectedDisk
                );

                if (isSuccess) {
                    // ç§»å‹•æˆåŠŸæ™‚ã®å‡¦ç†
                    if (isP1Move) {
                        moves++; movesDisplay.textContent = moves; 
                        p1TotalMoves++;
                    } else if (mode === 'two_player') {
                        p2TotalMoves++;
                    }
                    
                    // å‹åˆ©åˆ¤å®š
                    if (mode === 'two_player') {
                        checkTwoPlayerWin(isP1Move);
                    } else if (mode === 'versus' || mode === 'manual') {
                        checkWin(); 
                    }
                    
                    // ã‚¿ãƒ¼ãƒ³åˆ‡ã‚Šæ›¿ãˆ (2äººå¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰ã®ã¿)
                    if (!playerWon && !botWon && mode === 'two_player') {
                        currentPlayer = (currentPlayer === 1) ? 2 : 1;
                        messageDisplay.textContent = `P${currentPlayer} ã®ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚`;
                    }
                } else {
                    messageDisplay.textContent = `P${playerNumber}: ãƒ«ãƒ¼ãƒ«é•åã§ã™ã€‚ã‚¿ãƒ¼ãƒ³ã¯ãã®ã¾ã¾ç¶™ç¶šã—ã¾ã™ã€‚`;
                }
                
                resetSelection(isP1Move); 
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.addEventListener('keydown', handleKeyPress);
        
        // ãƒœãƒƒãƒˆè‡ªå‹•ã‚¯ãƒªã‚¢ã®é–‹å§‹ãƒœã‚¿ãƒ³å‡¦ç†
        executeButton.onclick = function() {
            if (gameModeSelect.value === 'bot_only') {
                initGame();
                currentBotSpeedMs = parseInt(botSpeedInput.value);
                generateBotMovesWithHandicap(disksCount, 0, 2, 1, 0); // æ­0ã‹ã‚‰æ­2ã¸ç§»å‹•
                startBotMoves(currentBotSpeedMs);
            } else {
                initGame();
            }
        };
        
        window.onload = updateModeDisplay; 
    </script>
</body>
</html>
