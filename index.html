<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒã‚¤ã®å¡” å…¨ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ</title>
    <style>
        /* ------------------ CSSã®å®šç¾© ------------------ */
        body { font-family: 'Arial', sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #f4f4f9; color: #333; margin: 20px; }
        .wrapper { max-width: 500px; width: 100%; transition: max-width 0.3s ease; }
        h1 { color: #6a0dad; margin-bottom: 10px; }
        #controls, #message-area { background-color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); margin-bottom: 20px; width: 100%; box-sizing: border-box; }
        #message-area { text-align: center; min-height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        #game-board { 
            display: flex; 
            justify-content: space-between; 
            margin-top: 20px; 
            transition: all 0.3s ease; 
            width: 100%; /* ãƒœãƒ¼ãƒ‰å…¨ä½“å¹…ã‚’ç¢ºä¿ */
            box-sizing: border-box;
        }
        .player-container, .bot-container { 
            flex-grow: 1; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            margin: 0 5px; 
            background-color: #f9f9f9; 
            box-sizing: border-box;
            min-width: 200px; /* æœ€å°å¹…ã‚’è¨­å®š */
        }
        .peg-container { display: flex; justify-content: space-around; height: 250px; align-items: flex-end; position: relative; }
        .peg { width: 10px; background-color: #8b4513; height: 100%; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); z-index: 1; }
        .peg-base { width: 100%; height: 15px; background-color: #5d2b0e; position: absolute; bottom: 0; z-index: 2; border-radius: 3px; }
        .peg-area { width: 30%; height: 100%; position: relative; cursor: pointer; display: flex; flex-direction: column-reverse; align-items: center; justify-content: flex-start; z-index: 3; padding-bottom: 15px; }
        .disk { height: 20px; background-color: #3498db; margin-bottom: 2px; border-radius: 5px; position: relative; z-index: 4; transition: all 0.2s ease-in-out; }
        .disk.selected { border: 3px solid #e74c3c; box-sizing: border-box; margin-top: -20px; }
        .disk.highlight { background-color: #2ecc71; }
        
        /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®ãŸã‚ã®CSS */
        .tooltip-container { position: relative; display: inline-block; cursor: help; color: #007bff; border-bottom: 1px dashed #007bff; }
        .tooltip-text {
            visibility: hidden;
            width: 300px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 10;
            bottom: 125%; 
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
            line-height: 1.4;
            white-space: normal;
        }
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .math-formula { display: block; margin: 5px 0; font-family: 'Courier New', monospace; background-color: #444; padding: 5px; border-radius: 3px; }
        /* ----------------------------------------------- */
    </style>
</head>
<body>

    <div class="wrapper" id="wrapper">
        <h1>ãƒãƒã‚¤ã®å¡”</h1>
        
        <div id="controls">
            <h2 style="margin-top: 0;">âš™ï¸ ã‚²ãƒ¼ãƒ è¨­å®š</h2>
            
            <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 15px;">
                <label for="game-mode" style="font-weight: bold;">ãƒ¢ãƒ¼ãƒ‰é¸æŠ:</label>
                <select id="game-mode" onchange="updateModeDisplay()">
                    <option value="manual" selected>1äººç”¨ (æ‰‹å‹•)</option>
                    <option value="versus">ãƒœãƒƒãƒˆã¨å¯¾æˆ¦</option>
                    <option value="two_player">2äººå¯¾æˆ¦ (è¨˜éŒ²å‹è² )</option>
                    <option value="bot_only">ãƒœãƒƒãƒˆ (è‡ªå‹•ã‚¯ãƒªã‚¢)</option>
                </select>
                
                <label for="disks" style="width: auto;">å††ç›¤ã®æ•° (3-64):</label> 
                <input type="number" id="disks" value="3" min="3" max="64">
                
                <button id="execute-button" onclick="initGame()">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
            </div>
            
            <div id="two-player-settings" style="display: none; width: 100%; margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 10px;">
                <h3 style="color: #6a0dad; margin: 5px 0 10px 0;">âš”ï¸ 2äººå¯¾æˆ¦è¨­å®š</h3>
                <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 15px;">
                    
                    <label for="win-condition" style="font-weight: bold;">å‹åˆ©æ¡ä»¶:</label>
                    <select id="win-condition">
                        <option value="min_moves_win">æœ€å°æ‰‹æ•°é”æˆ</option>
                        <option value="min_time_win">æœ€çŸ­æ™‚é–“é”æˆ</option>
                        <option value="mixed_win" selected>ãƒŸãƒƒã‚¯ã‚¹</option>
                    </select>
                    
                    <div class="tooltip-container">
                        [ãƒŸãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢ ãƒ˜ãƒ«ãƒ—]
                        <span class="tooltip-text">
                            <h4>ãƒŸãƒƒã‚¯ã‚¹åŠ¹ç‡ã‚¹ã‚³ã‚¢:</h4>
                            ã‚¹ãƒ”ãƒ¼ãƒ‰ã¨æ­£ç¢ºã•ã®ãƒãƒ©ãƒ³ã‚¹ã‚’è©•ä¾¡ã—ã¾ã™ã€‚ã‚¹ã‚³ã‚¢ãŒä½ã„æ–¹ãŒå‹åˆ©ã§ã™ã€‚
                            $$
                            \text{Score} = \text{Time (ç§’)} \times \frac{\text{Actual Moves}}{\text{Minimum Moves}}
                            $$
                            æœ€å°æ‰‹æ•° ($M = 2^N - 1$)
                        </span>
                    </div>

                    <label for="time-limit" style="font-weight: bold; color: #dc3545;">åˆ¶é™æ™‚é–“ (åˆ†):</label>
                    <input type="number" id="time-limit" value="0" min="0" max="60" style="width: 60px;">
                    <span style="font-size: 14px; margin-left: -5px;">(0ã§æ™‚é–“ç„¡åˆ¶é™)</span>
                </div>
            </div>
            
            <div id="rate-display" style="display: none; margin-top: 15px;">
                <label for="bot-speed">ãƒœãƒƒãƒˆã®é€Ÿåº¦ (ms):</label>
                <input type="number" id="bot-speed" value="500" min="10">
                <label for="handicap-moves" style="margin-left: 10px;">ãƒãƒ³ãƒ‡æ‰‹æ•°:</label>
                <input type="number" id="handicap-moves" value="0" min="0">
            </div>
        </div>

        <div id="message-area">ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¦ãã ã•ã„</div>

        <div style="display: flex; justify-content: space-between; width: 100%; margin-top: 10px; font-weight: bold;">
            <span>æ‰‹æ•°: <span id="moves-display">0</span> (æœ€å°: <span id="min-moves-display">7</span>)</span>
            <span>ã‚¿ã‚¤ãƒ : <span id="time-display">00:00.00</span></span>
        </div>

        <div id="game-board">
            <div class="player-container" id="player-container">
                <h3 style="text-align: center; color: #2980b9;" id="p1-title">P1 (ã‚­ãƒ¼: 1, 2, 3)</h3>
                <div class="peg-container">
                    <div class="peg-area" data-peg-index="0" id="peg-area-1"><div class="peg"></div><div class="peg-base"></div></div>
                    <div class="peg-area" data-peg-index="1" id="peg-area-2"><div class="peg"></div><div class="peg-base"></div></div>
                    <div class="peg-area" data-peg-index="2" id="peg-area-3"><div class="peg"></div><div class="peg-base"></div></div>
                </div>
            </div>
            
            <div class="bot-container" id="bot-container" style="display: none;">
                <h3 style="text-align: center; color: #c0392b;" id="bot-title">P2 (ã‚­ãƒ¼: 4, 5, 6)</h3>
                <div class="peg-container">
                    <div class="peg-area" data-peg-index="0" id="bot-peg-area-1"><div class="peg"></div><div class="peg-base"></div></div>
                    <div class="peg-area" data-peg-index="1" id="bot-peg-area-2"><div class="peg"></div><div class="peg-base"></div></div>
                    <div class="peg-area" data-peg-index="2" id="bot-peg-area-3"><div class="peg"></div><div class="peg-base"></div></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ------------------ JavaScriptã®å®šç¾© ------------------
        
        // DOMè¦ç´ ã®å–å¾—
        const gameModeSelect = document.getElementById('game-mode');
        const disksInput = document.getElementById('disks');
        const executeButton = document.getElementById('execute-button');
        const messageDisplay = document.getElementById('message-area');
        const movesDisplay = document.getElementById('moves-display');
        const minMovesDisplay = document.getElementById('min-moves-display');
        const timeDisplay = document.getElementById('time-display');
        const botSpeedControls = document.getElementById('rate-display');
        const botSpeedInput = document.getElementById('bot-speed');
        const handicapInput = document.getElementById('handicap-moves');
        const botTitle = document.getElementById('bot-title');
        const p1Title = document.getElementById('p1-title');
        const twoPlayerSettings = document.getElementById('two-player-settings');
        const winConditionSelect = document.getElementById('win-condition');
        const timeLimitInput = document.getElementById('time-limit');

        const playerContainer = document.getElementById('player-container');
        const botContainer = document.getElementById('bot-container');
        const wrapper = document.getElementById('wrapper');

        const playerPegElements = [
            document.getElementById('peg-area-1'),
            document.getElementById('peg-area-2'),
            document.getElementById('peg-area-3')
        ];
        const botPegElements = [
            document.getElementById('bot-peg-area-1'),
            document.getElementById('bot-peg-area-2'),
            document.getElementById('bot-peg-area-3')
        ];

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let disksCount = 3;
        let playerPegsState = [[], [], []];
        let botPegsState = [[], [], []];

        let timerInterval = null;
        let startTime = 0;
        let isTimerRunning = false;
        let moves = 0; // å…¨ä½“/P1ã®æ‰‹æ•° (éå¯¾æˆ¦ãƒ»P1æ“ä½œæ™‚ç”¨)
        let minMoves = 7;
        let playerWon = false;
        let botWon = false;

        let botMoveTimeout = null;
        let isBotRunning = false;
        let moveQueue = [];
        let botHandicapMoves = 0;
        let currentBotSpeedMs = 500;

        // â˜…2äººå¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰ã®è¨˜éŒ² (éåŒæ™‚ä¸¦è¡Œãƒ»è¨˜éŒ²æŒ‘æˆ¦åˆ¶)
        let p1TotalMoves = 0;
        let p2TotalMoves = 0;
        let p1ClearTimeMs = Infinity; 
        let p2ClearTimeMs = Infinity; 
        let current2PPlayer = 1; // 1: P1ã®æŒ‘æˆ¦, 2: P2ã®æŒ‘æˆ¦
        let p1RecordSet = false; // P1ã®è¨˜éŒ²ãŒç¢ºå®šã—ãŸã‹

        // é¸æŠçŠ¶æ…‹
        let selectedDisk = null;
        let sourcePegIndex = -1;
        
        // å®šæ•°
        const PEG_HEIGHT = 250;
        const DISK_MARGIN = 2;

        // ------------------ ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ ------------------

        function updateModeDisplay() {
            const mode = gameModeSelect.value;
            
            // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ã®ãƒªã‚»ãƒƒãƒˆ
            wrapper.style.maxWidth = '500px'; 
            playerContainer.style.width = '100%';
            botContainer.style.display = 'none';

            // è¨­å®šãƒ‘ãƒãƒ«ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            botSpeedControls.style.display = 'none';
            twoPlayerSettings.style.display = 'none';
            
            let buttonLabel = 'ã‚²ãƒ¼ãƒ é–‹å§‹';

            if (mode === 'versus') {
                botSpeedControls.style.display = 'flex';
                buttonLabel = 'ãƒœãƒƒãƒˆå¯¾æˆ¦é–‹å§‹';
                wrapper.style.maxWidth = '1000px'; 
                playerContainer.style.width = '48%'; 
                botContainer.style.display = 'block';
                p1Title.textContent = 'P1 (ã‚­ãƒ¼: 1, 2, 3)';
                botTitle.textContent = 'Bot (è‡ªå‹•)';
                botTitle.style.color = '#2c3e50';
            } else if (mode === 'two_player') {
                twoPlayerSettings.style.display = 'block';
                buttonLabel = 'P1æŒ‘æˆ¦é–‹å§‹';
                wrapper.style.maxWidth = '500px'; 
                playerContainer.style.width = '100%'; 
                botContainer.style.display = 'none'; // P2ã®ç›¤é¢ã¯ä½¿ã‚ãªã„ï¼ˆP1ã®ç›¤é¢ã‚’å…±æœ‰ï¼‰
                p1Title.textContent = 'P1 æŒ‘æˆ¦ä¸­ (ã‚­ãƒ¼: 1, 2, 3)';
            } else if (mode === 'bot_only') {
                botSpeedControls.style.display = 'flex';
                buttonLabel = 'è‡ªå‹•ã‚¯ãƒªã‚¢é–‹å§‹';
            } else { // manual
                buttonLabel = 'æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰é–‹å§‹';
            }
            
            executeButton.textContent = buttonLabel;
            initGame();
        }

        // ------------------ ã‚²ãƒ¼ãƒ åˆæœŸåŒ– ------------------

        function initGame() {
            if (timerInterval) clearInterval(timerInterval);
            if (botMoveTimeout) clearTimeout(botMoveTimeout);

            const newDisksCount = parseInt(disksInput.value);
            if (isNaN(newDisksCount) || newDisksCount < 3 || newDisksCount > 64) {
                alert("å††ç›¤ã®æ•°ã¯3ã‹ã‚‰64ã®é–“ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            disksCount = newDisksCount;
            
            // çŠ¶æ…‹ã¨DOMã®ãƒªã‚»ãƒƒãƒˆ
            playerPegsState = [[], [], []];
            botPegsState = [[], [], []];
            playerPegElements.forEach(peg => { while (peg.querySelector('.disk')) peg.querySelector('.disk').remove(); });
            botPegElements.forEach(peg => { while (peg.querySelector('.disk')) peg.querySelector('.disk').remove(); });

            moves = 0;
            movesDisplay.textContent = 0;
            minMoves = Math.pow(2, disksCount) - 1;
            minMovesDisplay.textContent = minMoves;
            timeDisplay.textContent = "00:00.00";
            playerWon = false;
            botWon = false;
            isTimerRunning = false;
            isBotRunning = false;
            moveQueue = [];

            // é¸æŠçŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
            resetSelection();

            // â˜…2äººå¯¾æˆ¦ç”¨ã®çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆã¨è¨­å®šå–å¾—
            current2PPlayer = 1; 
            p1TotalMoves = 0;
            p2TotalMoves = 0;
            p1ClearTimeMs = Infinity; 
            p2ClearTimeMs = Infinity; 
            p1RecordSet = false;
            timeLimitMinutes = parseInt(timeLimitInput.value);
            winCondition = winConditionSelect.value;
            
            // å††ç›¤ã®é…ç½®ãƒ­ã‚¸ãƒƒã‚¯
            setupDisks(playerPegsState, playerPegElements);
            if (gameModeSelect.value === 'versus') {
                setupDisks(botPegsState, botPegElements);
            }

            // ãƒ¢ãƒ¼ãƒ‰ã”ã¨ã®åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            const mode = gameModeSelect.value;
            if (mode === 'two_player') {
                messageDisplay.textContent = `âš”ï¸ 2äººå¯¾æˆ¦(è¨˜éŒ²å‹è² )ï¼P1ã®æŒ‘æˆ¦ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚`;
            } else if (mode === 'versus') {
                currentBotSpeedMs = parseInt(botSpeedInput.value);
                botHandicapMoves = parseInt(handicapInput.value);
                messageDisplay.textContent = "âš”ï¸ ãƒœãƒƒãƒˆå¯¾æˆ¦é–‹å§‹ï¼P1ã‹ã‚‰æ“ä½œã—ã¦ãã ã•ã„ã€‚";
            } else if (mode === 'bot_only') {
                currentBotSpeedMs = parseInt(botSpeedInput.value);
                messageDisplay.textContent = "ãƒœãƒƒãƒˆã«ã‚ˆã‚‹è‡ªå‹•ã‚¯ãƒªã‚¢ã‚’é–‹å§‹ãƒœã‚¿ãƒ³ã§é–‹å§‹ã—ã¾ã™ã€‚";
            } else { // manual
                messageDisplay.textContent = "æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚";
            }
        }
        
        /**
         * å††ç›¤ã‚’æ­0ã«é…ç½®ã™ã‚‹å‡¦ç†
         */
        function setupDisks(pegState, pegElements) {
            const totalMarginHeight = (disksCount - 1) * DISK_MARGIN;
            const availableHeight = PEG_HEIGHT - totalMarginHeight;
            const diskHeight = Math.floor(availableHeight / disksCount);
            const MIN_WIDTH = 50;
            const MAX_WIDTH = 180;
            const widthRange = MAX_WIDTH - MIN_WIDTH;

            for (let i = disksCount; i >= 1; i--) {
                const diskWidth = MIN_WIDTH + ((i - 1) / (disksCount - 1 || 1)) * widthRange;
                const hue = (i / disksCount) * 360;

                const disk = document.createElement('div');
                disk.classList.add('disk');
                disk.dataset.size = i;
                disk.style.width = `${diskWidth}px`;
                disk.style.height = `${diskHeight}px`;
                disk.style.backgroundColor = `hsl(${hue}, 80%, 50%)`;
                pegElements[0].appendChild(disk);
                pegState[0].push(i);
            }
        }

        // ------------------ ã‚¿ã‚¤ãƒãƒ¼é–¢æ•° ------------------

        function updateTimer() {
            const elapsed = Date.now() - startTime;
            const totalSeconds = Math.floor(elapsed / 1000);
            const milliseconds = Math.floor(elapsed % 1000 / 10);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            timeDisplay.textContent = 
                `${String(minutes).padStart(2, '0')}:` +
                `${String(seconds).padStart(2, '0')}.` +
                `${String(milliseconds).padStart(2, '0')}`;
        }
        
        function updateCountdownTimer(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const milliseconds = Math.floor(ms % 1000 / 10);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const formattedTime = 
                `${String(minutes).padStart(2, '0')}:` +
                `${String(seconds).padStart(2, '0')}.` +
                `${String(milliseconds).padStart(2, '0')}`;
            timeDisplay.textContent = formattedTime;
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            isTimerRunning = true;
            
            const limitMs = timeLimitMinutes * 60 * 1000;
            
            if (gameModeSelect.value === 'two_player' && timeLimitMinutes > 0) {
                // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒãƒ¼
                startTime = Date.now();
                timerInterval = setInterval(() => {
                    const elapsed = Date.now() - startTime;
                    const remaining = limitMs - elapsed;

                    if (remaining <= 0) {
                        clearInterval(timerInterval);
                        timeDisplay.textContent = "00:00.00";
                        handleTimeOver();
                        return;
                    }
                    updateCountdownTimer(remaining);
                }, 10);
            } else {
                // ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒãƒ¼ (é€šå¸¸/æ™‚é–“ç„¡åˆ¶é™)
                startTime = Date.now();
                timerInterval = setInterval(updateTimer, 10);
            }
        }

        function stopTimer() {
            if (timerInterval) clearInterval(timerInterval);
            isTimerRunning = false;
        }
        
        function handleTimeOver() {
            if (playerWon || botWon) return; 

            if (gameModeSelect.value === 'two_player') {
                stopTimer();
                if (current2PPlayer === 1) {
                    p1RecordSet = true;
                    p1TotalMoves = Infinity;
                    p1ClearTimeMs = Infinity;
                    messageDisplay.textContent = "âŒ› P1 ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—ï¼è¨˜éŒ²ã¯ç„¡åŠ¹ã§ã™ã€‚P2ã®æŒ‘æˆ¦ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚";
                    resetGameForP2();
                } else {
                    // P2ã‚‚ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—ã®å ´åˆ
                    messageDisplay.textContent = "âŒ› P2 ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—ï¼å‹è² ã¯P1ã®è¨˜éŒ²å‹ã¡ã¨ãªã‚Šã¾ã™ã€‚";
                    playerWon = true;
                    // å‹æ•—åˆ¤å®šã‚’å¼·åˆ¶å®Ÿè¡Œ
                    checkTwoPlayerWin(false);
                }
            }
        }

        // ------------------ ãƒœãƒƒãƒˆåˆ¶å¾¡é–¢æ•° (ãƒãƒã‚¤ã®å¡”ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ) ------------------

        function hanoi(n, source, destination, auxiliary, movesArray) {
            if (n === 1) {
                movesArray.push({ from: source, to: destination });
                return;
            }
            hanoi(n - 1, source, auxiliary, destination, movesArray);
            movesArray.push({ from: source, to: destination });
            hanoi(n - 1, auxiliary, destination, source, movesArray);
        }

        function generateBotMovesWithHandicap(n, source, destination, auxiliary, handicap) {
            moveQueue = [];
            hanoi(n, source, destination, auxiliary, moveQueue);
            
            // ãƒãƒ³ãƒ‡å‡¦ç†: æœ€åˆã®æ•°æ‰‹ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆä¾‹: æ­£ç¢ºãªæ‰‹é †ç”Ÿæˆå¾Œã®æœ€åˆã®æ•°æ‰‹ã‚’å‰Šé™¤ï¼‰
            if (handicap > 0 && moveQueue.length > handicap) {
                 moveQueue.splice(0, handicap);
            } else if (handicap > 0 && moveQueue.length <= handicap) {
                 // å††ç›¤æ•°ã«å¯¾ã—ã¦ãƒãƒ³ãƒ‡ãŒå¤§ãã™ãã‚‹å ´åˆã¯è­¦å‘Š
                 console.warn("Handicap is too large for the number of disks.");
                 moveQueue = []; // å…¨ç§»å‹•ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ« (å®Ÿè³ªçš„ãªæ•—åŒ—)
            }
        }

        function startBotMoves(speedMs) {
            if (isBotRunning || playerWon || botWon || moveQueue.length === 0) return;
            isBotRunning = true;
            
            if (!isTimerRunning) startTimer();

            function nextMove() {
                if (moveQueue.length === 0 || playerWon || botWon) {
                    isBotRunning = false;
                    return;
                }
                
                const move = moveQueue.shift();
                const source = move.from;
                const target = move.to;

                // DOMè¦ç´ ã¨çŠ¶æ…‹ã‚’å–å¾— (ãƒœãƒƒãƒˆã¯botPegElementsã¨botPegsStateã‚’ä½¿ç”¨)
                const diskElement = botPegElements[source].querySelector('.disk:last-child');
                
                if (attemptMoveUniversal(source, target, botPegElements, botPegsState, diskElement)) {
                    moves++; movesDisplay.textContent = moves; 
                    botWinCheck();

                    if (!playerWon && !botWon) {
                        botMoveTimeout = setTimeout(nextMove, speedMs);
                    }
                } else {
                    // ãƒ«ãƒ¼ãƒ«é•åãŒç™ºç”Ÿã—ãŸå ´åˆ (é€šå¸¸ã¯ç™ºç”Ÿã—ãªã„)
                    console.error("Bot made an illegal move.");
                    isBotRunning = false;
                }
            }

            botMoveTimeout = setTimeout(nextMove, speedMs);
        }

        // ------------------ ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ------------------

        function attemptMoveUniversal(sourceIndex, targetIndex, pegElements, pegState, diskElement) {
            const targetPeg = pegElements[targetIndex];
            const topDiskOnTarget = targetPeg.querySelector('.disk:last-child');
            
            if (!diskElement) return false; 

            const selectedSize = parseInt(diskElement.dataset.size);
            const topDiskSize = topDiskOnTarget ? parseInt(topDiskOnTarget.dataset.size) : Infinity;

            if (selectedSize < topDiskSize) {
                // DOMã®ç§»å‹•
                diskElement.parentNode.removeChild(diskElement);
                targetPeg.appendChild(diskElement);
                
                // çŠ¶æ…‹ã®æ›´æ–°
                pegState[sourceIndex].pop();
                pegState[targetIndex].push(selectedSize);

                return true;
            } else {
                return false;
            }
        }

        /**
         * 2äººå¯¾æˆ¦ï¼ˆè¨˜éŒ²æŒ‘æˆ¦åˆ¶ï¼‰ã®å‹åˆ©åˆ¤å®š
         * @param {boolean} isP1 - P1ã®ç›¤é¢ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹å ´åˆ true (P2ã®æŒ‘æˆ¦æ™‚ã‚‚P1ã®ç›¤é¢ã‚’ä½¿ç”¨)
         */
        function checkTwoPlayerWin(isTimeOver) {
            if (playerWon || botWon) return; 

            // P1/P2ã©ã¡ã‚‰ã®æŒ‘æˆ¦æ™‚ã‚‚playerPegsStateã‚’ä½¿ç”¨
            const targetState = playerPegsState;
            const isCleared = (targetState[1].length === disksCount) || (targetState[2].length === disksCount);
            
            if (current2PPlayer === 1) {
                // P1ã®ã‚¯ãƒªã‚¢å‡¦ç†
                if (isCleared || isTimeOver) {
                    stopTimer();
                    p1RecordSet = true;
                    p1TotalMoves = moves;
                    p1ClearTimeMs = isTimeOver ? Infinity : (Date.now() - startTime);
                    
                    if (isTimeOver) {
                        // ã‚¿ã‚¤ãƒ ã‚ªãƒ¼ãƒãƒ¼ã¯initGame()ã®å¤–ã§å‡¦ç†
                    } else {
                        messageDisplay.textContent = `âœ… P1ã‚¯ãƒªã‚¢ï¼è¨˜éŒ²: æ‰‹æ•°${p1TotalMoves}å›, æ™‚é–“${(p1ClearTimeMs/1000).toFixed(2)}ç§’ã€‚P2ã®æŒ‘æˆ¦ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚`;
                    }
                    resetGameForP2();
                }
            } else if (current2PPlayer === 2) {
                // P2ã®ã‚¯ãƒªã‚¢å‡¦ç†
                if (isCleared || isTimeOver) {
                    stopTimer();
                    p2TotalMoves = moves;
                    p2ClearTimeMs = isTimeOver ? Infinity : (Date.now() - startTime);

                    if (isTimeOver) {
                         messageDisplay.textContent = `âŒ P2 ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—ï¼å‹æ•—åˆ¤å®šã«å…¥ã‚Šã¾ã™...`;
                    } else {
                         messageDisplay.textContent = `âœ… P2ã‚¯ãƒªã‚¢ï¼è¨˜éŒ²: æ‰‹æ•°${p2TotalMoves}å›, æ™‚é–“${(p2ClearTimeMs/1000).toFixed(2)}ç§’ã€‚å‹æ•—åˆ¤å®šã«å…¥ã‚Šã¾ã™...`;
                    }
                    
                    // å‹æ•—åˆ¤å®š
                    determineWinner();
                }
            }
        }

        function determineWinner() {
            let winnerMessage = '';
            let p1Score = 0;
            let p2Score = 0;
            const M = minMoves; 

            // P1ãŒã‚¿ã‚¤ãƒ ã‚ªãƒ¼ãƒãƒ¼ã§è¨˜éŒ²ç„¡ã—ã®å ´åˆ
            if (p1ClearTimeMs === Infinity && p2ClearTimeMs !== Infinity) {
                botWon = true; // P2ã®å‹åˆ©
                messageDisplay.textContent += ` ğŸ‰ P2ã®å‹åˆ©ã§ã™ï¼(P1è¨˜éŒ²ç„¡ã—)`;
                return;
            }
            if (p2ClearTimeMs === Infinity && p1ClearTimeMs !== Infinity) {
                playerWon = true; // P1ã®å‹åˆ©
                messageDisplay.textContent += ` ğŸ‰ P1ã®å‹åˆ©ã§ã™ï¼(P2è¨˜éŒ²ç„¡ã—)`;
                return;
            }
            if (p1ClearTimeMs === Infinity && p2ClearTimeMs === Infinity) {
                messageDisplay.textContent += ` ğŸ¤ å¼•ãåˆ†ã‘ã§ã™ã€‚(ä¸¡è€…è¨˜éŒ²ç„¡ã—)`;
                return;
            }


            if (winCondition === 'min_moves_win') {
                p1Score = p1TotalMoves;
                p2Score = p2TotalMoves;
                winnerMessage = 'æœ€å°æ‰‹æ•°';
            } else if (winCondition === 'min_time_win') {
                p1Score = p1ClearTimeMs;
                p2Score = p2ClearTimeMs;
                winnerMessage = 'æœ€çŸ­æ™‚é–“';
            } else if (winCondition === 'mixed_win') {
                // ãƒŸãƒƒã‚¯ã‚¹åŠ¹ç‡ã‚¹ã‚³ã‚¢: Score = Time (ç§’) Ã— (Actual Moves / Minimum Moves)
                const p1TimeSec = p1ClearTimeMs / 1000;
                const p2TimeSec = p2ClearTimeMs / 1000;
                
                p1Score = p1TimeSec * (p1TotalMoves / M);
                p2Score = p2TimeSec * (p2TotalMoves / M);
                
                winnerMessage = 'ãƒŸãƒƒã‚¯ã‚¹åŠ¹ç‡ã‚¹ã‚³ã‚¢';
            }

            if (p1Score < p2Score) {
                playerWon = true;
                messageDisplay.textContent = ` ğŸ‰ P1 ã®å‹åˆ©ã§ã™ï¼ (${winnerMessage}é”æˆ)`;
            } else if (p2Score < p1Score) {
                botWon = true; // P2ã®å‹åˆ©
                messageDisplay.textContent = ` ğŸ‰ P2 ã®å‹åˆ©ã§ã™ï¼ (${winnerMessage}é”æˆ)`;
            } else {
                messageDisplay.textContent = ` ğŸ¤ å¼•ãåˆ†ã‘ã§ã™ï¼ (${winnerMessage}ãŒåŒç‚¹)`;
            }
            
            // è©³ç´°ã‚¹ã‚³ã‚¢ã®è¡¨ç¤º
            let detailMessage = ` | P1è¨˜éŒ²: æ‰‹æ•°${p1TotalMoves}å›, æ™‚é–“${(p1ClearTimeMs/1000).toFixed(2)}ç§’`;
            detailMessage += ` | P2è¨˜éŒ²: æ‰‹æ•°${p2TotalMoves}å›, æ™‚é–“${(p2ClearTimeMs/1000).toFixed(2)}ç§’`;
            if (winCondition === 'mixed_win') {
                detailMessage += ` | P1ã‚¹ã‚³ã‚¢: ${p1Score.toFixed(2)}, P2ã‚¹ã‚³ã‚¢: ${p2Score.toFixed(2)}`;
            }
            messageDisplay.textContent += detailMessage;
        }

        function resetGameForP2() {
            current2PPlayer = 2;
            executeButton.textContent = 'P2æŒ‘æˆ¦é–‹å§‹';
            
            // ç›¤é¢ã¨æ‰‹æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
            playerPegsState = [[], [], []];
            playerPegElements.forEach(peg => { while (peg.querySelector('.disk')) peg.querySelector('.disk').remove(); });
            setupDisks(playerPegsState, playerPegElements);
            
            moves = 0;
            movesDisplay.textContent = 0;
            timeDisplay.textContent = "00:00.00";
            
            p1Title.textContent = `P2 æŒ‘æˆ¦ä¸­ (ç›®æ¨™: P1ã®è¨˜éŒ²ã‚’ä¸Šå›ã‚Œ!)`;
        }
        
        // æ—¢å­˜ã®å‹åˆ©åˆ¤å®šé–¢æ•°ï¼ˆãƒœãƒƒãƒˆ/æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰
        function checkWin() { 
            if (playerPegsState[1].length === disksCount || playerPegsState[2].length === disksCount) {
                if (!playerWon) {
                    playerWon = true;
                    stopTimer();
                    messageDisplay.textContent = `ğŸ‰ P1 ã®å‹åˆ©ã§ã™ï¼ã‚¿ã‚¤ãƒ : ${timeDisplay.textContent}ã€æ‰‹æ•°: ${moves} å›`;
                    if (gameModeSelect.value === 'versus') {
                        if (botMoveTimeout) clearTimeout(botMoveTimeout);
                        isBotRunning = false;
                    }
                }
            }
        }
        
        function botWinCheck() { 
            const mode = gameModeSelect.value;
            if (botPegsState[1].length === disksCount || botPegsState[2].length === disksCount) {
                if (!botWon) {
                    botWon = true;
                    stopTimer();
                    if(mode === 'versus') {
                        messageDisplay.textContent = `ğŸ˜­ ãƒœãƒƒãƒˆã®å‹åˆ©ã§ã™ã€‚ã‚¿ã‚¤ãƒ : ${timeDisplay.textContent}ã€æ‰‹æ•°: ${moves} å›`;
                    }
                    if (mode === 'bot_only') {
                        messageDisplay.textContent = `âœ… ãƒœãƒƒãƒˆãŒã‚¯ãƒªã‚¢ã—ã¾ã—ãŸï¼ã‚¿ã‚¤ãƒ : ${timeDisplay.textContent}ã€æ‰‹æ•°: ${moves} å›`;
                        if (botMoveTimeout) clearTimeout(botMoveTimeout);
                        isBotRunning = false;
                    }
                }
            }
        }


        // ------------------ é¸æŠçŠ¶æ…‹ã®ãƒªã‚»ãƒƒãƒˆ ------------------

        function resetSelection() {
            if (selectedDisk) selectedDisk.classList.remove('selected');
            selectedDisk = null;
            sourcePegIndex = -1;
        }
        
        // ------------------ ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›å‡¦ç† ------------------

        function handleKeyPress(event) {
            const mode = gameModeSelect.value;
            if (mode === 'bot_only' || isBotRunning) return; 
            if (playerWon || botWon) return; 

            const key = event.key;
            let pegIndex = -1;
            let playerNumber = 1; // å¸¸ã«P1/P2ã®æŒ‘æˆ¦è€…ï¼ˆplayerPegsStateã‚’ä½¿ç”¨ï¼‰

            // ã‚­ãƒ¼å…¥åŠ›ã¯P1/P2ã¨ã‚‚ã«1, 2, 3ã‚’ä½¿ç”¨ (2äººå¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰ã§ã¯ç›¤é¢ã‚’å…±æœ‰ã™ã‚‹ãŸã‚)
            if (key === '1' || key === '2' || key === '3') {
                pegIndex = parseInt(key) - 1; 
            } else if (key === 'Escape') {
                resetSelection();
                messageDisplay.textContent = "é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚";
                return;
            } else {
                return; 
            }
            
            // 2äººå¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰ã§ã¯P1ã®ç›¤é¢ã®ã¿ä½¿ç”¨
            const targetPegElements = playerPegElements;
            const pegState = playerPegsState;
            
            const currentPegElement = targetPegElements[pegIndex];
            
            if (sourcePegIndex === -1) {
                // --- 1. å††ç›¤ã®é¸æŠ ---
                const topDisk = currentPegElement.querySelector('.disk:last-child');
                if (topDisk) {
                    if (!isTimerRunning) {
                         startTimer();
                         // ãƒœãƒƒãƒˆå¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹æ™‚ã«ãƒœãƒƒãƒˆã®æ‰‹é †ã‚’æº–å‚™ã—ã€é–‹å§‹
                         if(mode === 'versus') {
                             generateBotMovesWithHandicap(disksCount, 0, 1, 2, botHandicapMoves);
                             startBotMoves(currentBotSpeedMs);
                         } 
                    } 

                    topDisk.classList.add('selected');
                    sourcePegIndex = pegIndex;
                    selectedDisk = topDisk;
                    messageDisplay.textContent = `P${current2PPlayer}: æ­ ${pegIndex + 1} ã‚’å§‹ç‚¹ã¨ã—ã¦é¸æŠã€‚ç§»å‹•å…ˆã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`;
                } else {
                    messageDisplay.textContent = `P${current2PPlayer}: æ­ ${pegIndex + 1} ã«ã¯å‹•ã‹ã›ã‚‹å††ç›¤ãŒã‚ã‚Šã¾ã›ã‚“ã€‚`;
                }
            } else {
                // --- 2. å††ç›¤ã®ç§»å‹• ---
                const targetPegIndex = pegIndex;
                if (sourcePegIndex === targetPegIndex) {
                    resetSelection(); 
                    messageDisplay.textContent = `P${current2PPlayer}: é¸æŠã‚’è§£é™¤ã—ã¾ã—ãŸã€‚`;
                    return;
                }

                const isSuccess = attemptMoveUniversal(
                    sourcePegIndex, 
                    targetPegIndex, 
                    targetPegElements,
                    pegState,
                    selectedDisk
                );

                if (isSuccess) {
                    moves++; movesDisplay.textContent = moves; 
                    
                    // å‹åˆ©åˆ¤å®š
                    if (mode === 'two_player') {
                        checkTwoPlayerWin(false); // 2äººå¯¾æˆ¦ã®è¨˜éŒ²åˆ¤å®š
                    } else if (mode === 'versus' || mode === 'manual') {
                        checkWin(); // 1äººãƒ—ãƒ¬ã‚¤ã€ãƒœãƒƒãƒˆå¯¾æˆ¦ã®å‹åˆ©åˆ¤å®š
                    }
                } else {
                    messageDisplay.textContent = `P${playerNumber}: ãƒ«ãƒ¼ãƒ«é•åã§ã™ã€‚`;
                }
                
                resetSelection(); 
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.addEventListener('keydown', handleKeyPress);
        
        // é–‹å§‹ãƒœã‚¿ãƒ³å‡¦ç†
        executeButton.onclick = function() {
            const mode = gameModeSelect.value;
            
            if (mode === 'two_player' && !p1RecordSet) {
                // P1ã®æŒ‘æˆ¦é–‹å§‹
                initGame();
                messageDisplay.textContent = `P1ã®æŒ‘æˆ¦é–‹å§‹ï¼æœ€çŸ­ã§ã®ã‚¯ãƒªã‚¢ã‚’ç›®æŒ‡ã—ã¦ãã ã•ã„ã€‚`;
                executeButton.textContent = 'P1æŒ‘æˆ¦ä¸­...';
                executeButton.disabled = true;
                // ã‚¿ã‚¤ãƒãƒ¼ã¯æœ€åˆã®æ“ä½œã§é–‹å§‹
            } else if (mode === 'two_player' && p1RecordSet) {
                // P2ã®æŒ‘æˆ¦é–‹å§‹
                resetGameForP2();
                messageDisplay.textContent = `P2ã®æŒ‘æˆ¦é–‹å§‹ï¼P1ã®è¨˜éŒ² (${winConditionSelect.options[winConditionSelect.selectedIndex].text}) ã‚’è¶…ãˆã‚ï¼`;
                executeButton.textContent = 'P2æŒ‘æˆ¦ä¸­...';
                executeButton.disabled = true;
                // ã‚¿ã‚¤ãƒãƒ¼ã¯æœ€åˆã®æ“ä½œã§é–‹å§‹
            } else if (mode === 'bot_only') {
                // ãƒœãƒƒãƒˆè‡ªå‹•ã‚¯ãƒªã‚¢
                initGame();
                currentBotSpeedMs = parseInt(botSpeedInput.value);
                // ãƒœãƒƒãƒˆè‡ªå‹•ã‚¯ãƒªã‚¢ã¯P1ã®ç›¤é¢ (playerPegsState) ã‚’ä½¿ã£ã¦ã€æ­0ã‹ã‚‰æ­2ã¸ç§»å‹•
                generateBotMovesWithHandicap(disksCount, 0, 2, 1, 0); 
                startBotMoves(currentBotSpeedMs);
                executeButton.textContent = 'è‡ªå‹•ã‚¯ãƒªã‚¢ä¸­...';
                executeButton.disabled = true;
            } else {
                // æ‰‹å‹•/ãƒœãƒƒãƒˆå¯¾æˆ¦ï¼ˆæœ€åˆã®æ“ä½œã§ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ï¼‰
                initGame();
            }
        };

        window.onload = updateModeDisplay; 
    </script>
</body>
</html>
